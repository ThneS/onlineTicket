# OnlineTicket åç«¯ API æœåŠ¡

åŸºäº Node.js + Express + Prisma + Redis æ„å»ºçš„ Web3 ç¥¨åŠ¡å¹³å°åç«¯æœåŠ¡ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **REST API**: å®Œæ•´çš„ RESTful API æ¥å£
- **åŒºå—é“¾åŒæ­¥**: è‡ªåŠ¨åŒæ­¥åŒºå—é“¾äº‹ä»¶åˆ°æ•°æ®åº“
- **æ•°æ®ç¼“å­˜**: Redis ç¼“å­˜æå‡æ€§èƒ½
- **ç”¨æˆ·è®¤è¯**: JWT èº«ä»½éªŒè¯
- **æ•°æ®åº“**: PostgreSQL + Prisma ORM
- **æ—¥å¿—ç³»ç»Ÿ**: Winston ç»“æ„åŒ–æ—¥å¿—
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript æ”¯æŒ

## ğŸ“ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ routes/              # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ auth.ts         # ç”¨æˆ·è®¤è¯
â”‚   â”‚   â”œâ”€â”€ events.ts       # æ´»åŠ¨ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ tickets.ts      # é—¨ç¥¨ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ orders.ts       # è®¢å•ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ swap.ts         # ä»£å¸äº¤æ¢
â”‚   â”‚   â””â”€â”€ admin.ts        # ç³»ç»Ÿç®¡ç†
â”‚   â”œâ”€â”€ services/           # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ database.ts     # æ•°æ®åº“æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ redis.ts        # ç¼“å­˜æœåŠ¡
â”‚   â”‚   â””â”€â”€ blockchainSync.ts # åŒºå—é“¾åŒæ­¥
â”‚   â”œâ”€â”€ middleware/         # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.ts         # è®¤è¯ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ errorHandler.ts # é”™è¯¯å¤„ç†
â”‚   â”œâ”€â”€ utils/              # å·¥å…·ç±»
â”‚   â”‚   â””â”€â”€ logger.ts       # æ—¥å¿—å·¥å…·
â”‚   â”œâ”€â”€ scripts/            # è„šæœ¬
â”‚   â”‚   â””â”€â”€ seed.ts         # æ•°æ®åˆå§‹åŒ–
â”‚   â””â”€â”€ server.ts           # æœåŠ¡å™¨å…¥å£
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma       # æ•°æ®åº“æ¨¡å¼
â”œâ”€â”€ logs/                   # æ—¥å¿—æ–‡ä»¶
â””â”€â”€ package.json
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **è¿è¡Œæ—¶**: Node.js 18+
- **æ¡†æ¶**: Express.js
- **æ•°æ®åº“**: PostgreSQL
- **ORM**: Prisma
- **ç¼“å­˜**: Redis
- **è®¤è¯**: JWT
- **æ—¥å¿—**: Winston
- **åŒºå—é“¾**: Viem

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js >= 18.0.0
- PostgreSQL >= 13
- Redis >= 6
- è¿è¡Œä¸­çš„ä»¥å¤ªåŠèŠ‚ç‚¹ (Anvil/Hardhat)

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. ç¯å¢ƒé…ç½®

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡
vim .env
```

### 3. æ•°æ®åº“è®¾ç½®

```bash
# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
npx prisma generate

# æ‰§è¡Œæ•°æ®åº“è¿ç§»
npx prisma migrate dev --name init

# åˆå§‹åŒ–æ•°æ® (å¯é€‰)
npm run db:seed
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm run build
npm start

# ä½¿ç”¨å¯åŠ¨è„šæœ¬
chmod +x start.sh
./start.sh
```

## ğŸ“š API æ–‡æ¡£

### è®¤è¯ç›¸å…³

- `POST /api/v1/auth/nonce` - è·å–ç™»å½•éšæœºæ•°
- `POST /api/v1/auth/login` - ç”¨æˆ·ç™»å½•

### æ´»åŠ¨ç®¡ç†

- `GET /api/v1/events` - è·å–æ´»åŠ¨åˆ—è¡¨
- `GET /api/v1/events/:id` - è·å–æ´»åŠ¨è¯¦æƒ…
- `GET /api/v1/events/:id/stats` - è·å–æ´»åŠ¨ç»Ÿè®¡

### é—¨ç¥¨ç®¡ç†

- `GET /api/v1/tickets/my` - è·å–æˆ‘çš„é—¨ç¥¨ (éœ€è®¤è¯)
- `GET /api/v1/tickets/:id` - è·å–é—¨ç¥¨è¯¦æƒ…

### è®¢å•ç®¡ç†

- `GET /api/v1/orders/my` - è·å–æˆ‘çš„è®¢å• (éœ€è®¤è¯)
- `GET /api/v1/orders/:id` - è·å–è®¢å•è¯¦æƒ… (éœ€è®¤è¯)

### ä»£å¸äº¤æ¢

- `GET /api/v1/swap/prices` - è·å–ä»£å¸ä»·æ ¼
- `GET /api/v1/swap/pools` - è·å–æµåŠ¨æ€§æ± 
- `POST /api/v1/swap/quote` - è®¡ç®—äº¤æ¢ä»·æ ¼

### ç³»ç»Ÿç®¡ç†

- `GET /api/v1/admin/status` - ç³»ç»ŸçŠ¶æ€
- `GET /api/v1/admin/stats` - ç³»ç»Ÿç»Ÿè®¡

## ğŸ”§ å¼€å‘å‘½ä»¤

| å‘½ä»¤                 | æè¿°           |
| -------------------- | -------------- |
| `npm run dev`        | å¯åŠ¨å¼€å‘æœåŠ¡å™¨ |
| `npm run build`      | æ„å»ºç”Ÿäº§ç‰ˆæœ¬   |
| `npm start`          | å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨ |
| `npm test`           | è¿è¡Œæµ‹è¯•       |
| `npm run lint`       | ä»£ç æ£€æŸ¥       |
| `npm run db:migrate` | æ•°æ®åº“è¿ç§»     |
| `npm run db:seed`    | åˆå§‹åŒ–æ•°æ®     |

## ğŸŒ æœåŠ¡ç«¯ç‚¹

- **HTTP API**: http://localhost:3001
- **å¥åº·æ£€æŸ¥**: http://localhost:3001/health
- **API æ–‡æ¡£**: http://localhost:3001/api/v1/docs (è®¡åˆ’ä¸­)

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—æ–‡ä»¶

- `logs/combined.log` - ç»¼åˆæ—¥å¿—
- `logs/error.log` - é”™è¯¯æ—¥å¿—
- æ§åˆ¶å°è¾“å‡º - å¼€å‘ç¯å¢ƒå®æ—¶æ—¥å¿—

### å¥åº·æ£€æŸ¥

```bash
curl http://localhost:3001/health
```

### ç³»ç»ŸçŠ¶æ€

```bash
curl http://localhost:3001/api/v1/admin/status
```

## ğŸ”„ åŒºå—é“¾åŒæ­¥

åç«¯æœåŠ¡ä¼šè‡ªåŠ¨ç›‘å¬å¹¶åŒæ­¥ä»¥ä¸‹åŒºå—é“¾äº‹ä»¶ï¼š

- **EventCreated** - æ–°æ´»åŠ¨åˆ›å»º
- **TicketMinted** - é—¨ç¥¨é“¸é€ 
- **Transfer** - é—¨ç¥¨è½¬ç§»
- **OrderCreated** - è®¢å•åˆ›å»º

åŒæ­¥é—´éš”ï¼š30 ç§’

## ğŸ’¾ æ•°æ®åº“æ¨¡å¼

### ä¸»è¦è¡¨ç»“æ„

- **users** - ç”¨æˆ·ä¿¡æ¯
- **events** - æ´»åŠ¨ä¿¡æ¯
- **tickets** - é—¨ç¥¨ä¿¡æ¯
- **orders** - è®¢å•ä¿¡æ¯
- **token_prices** - ä»£å¸ä»·æ ¼
- **liquidity_pools** - æµåŠ¨æ€§æ± 
- **blockchain_sync** - åŒæ­¥çŠ¶æ€

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- **JWT è®¤è¯** - æ¥å£è®¿é—®æ§åˆ¶
- **é™æµä¿æŠ¤** - é˜²æ­¢ API æ»¥ç”¨
- **CORS é…ç½®** - è·¨åŸŸè¯·æ±‚æ§åˆ¶
- **Helmet ä¸­é—´ä»¶** - HTTP å®‰å…¨å¤´
- **è¾“å…¥éªŒè¯** - å‚æ•°æ ¡éªŒå’Œæ¸…ç†

## ğŸš€ éƒ¨ç½²æŒ‡å—

### Docker éƒ¨ç½² (è®¡åˆ’ä¸­)

```bash
# æ„å»ºé•œåƒ
docker build -t onlineticket-backend .

# è¿è¡Œå®¹å™¨
docker run -p 3001:3001 onlineticket-backend
```

### ç¯å¢ƒå˜é‡é…ç½®

ç”Ÿäº§ç¯å¢ƒéœ€è¦é…ç½®ä»¥ä¸‹å…³é”®å˜é‡ï¼š

- `NODE_ENV=production`
- `DATABASE_URL` - ç”Ÿäº§æ•°æ®åº“è¿æ¥
- `REDIS_URL` - Redis è¿æ¥
- `JWT_SECRET` - JWT å¯†é’¥
- `RPC_URL` - ä¸»ç½‘/æµ‹è¯•ç½‘ RPC ç«¯ç‚¹

## ğŸ¤ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ API ç«¯ç‚¹

1. åœ¨ `src/routes/` ä¸­åˆ›å»ºè·¯ç”±æ–‡ä»¶
2. åœ¨ `src/server.ts` ä¸­æ³¨å†Œè·¯ç”±
3. æ·»åŠ ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹

### æ•°æ®åº“æ¨¡å¼å˜æ›´

1. ä¿®æ”¹ `prisma/schema.prisma`
2. è¿è¡Œ `npx prisma migrate dev --name <migration-name>`
3. æ›´æ–°ç§å­æ•°æ® (å¦‚éœ€è¦)

### åŒºå—é“¾äº‹ä»¶å¤„ç†

1. åœ¨ `src/services/blockchainSync.ts` ä¸­æ·»åŠ äº‹ä»¶å¤„ç†å™¨
2. å®šä¹‰å¯¹åº”çš„ ABI ç‰‡æ®µ
3. å®ç°æ•°æ®åŒæ­¥é€»è¾‘

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- **æ•°æ®åº“ç´¢å¼•** - å…³é”®å­—æ®µå»ºç«‹ç´¢å¼•
- **Redis ç¼“å­˜** - çƒ­ç‚¹æ•°æ®ç¼“å­˜
- **è¿æ¥æ± ** - æ•°æ®åº“è¿æ¥å¤ç”¨
- **åˆ†é¡µæŸ¥è¯¢** - å¤§æ•°æ®é›†åˆ†é¡µå¤„ç†

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**

   - æ£€æŸ¥ `DATABASE_URL` é…ç½®
   - ç¡®è®¤ PostgreSQL æœåŠ¡è¿è¡ŒçŠ¶æ€

2. **åŒºå—é“¾åŒæ­¥å¼‚å¸¸**

   - æ£€æŸ¥ `RPC_URL` é…ç½®
   - ç¡®è®¤åˆçº¦åœ°å€æ­£ç¡®

3. **Redis è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ `REDIS_URL` é…ç½®
   - ç¡®è®¤ Redis æœåŠ¡è¿è¡ŒçŠ¶æ€

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è°ƒè¯•æ—¥å¿—
LOG_LEVEL=debug npm run dev
```

## ğŸ“„ è®¸å¯è¯

MIT License - æŸ¥çœ‹ [LICENSE](../LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚
